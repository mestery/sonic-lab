version: "3.9"

networks:
  spine-leaf1-link1:
    driver: bridge
    internal: true

  spine-leaf1-link2:
    driver: bridge
    internal: true

  spine-leaf2-link1:
    driver: bridge
    internal: true

  spine-leaf2-link2:
    driver: bridge
    internal: true

x-sonic-common: &sonic-common
  image: docker-sonic-vs:latest
  platform: linux/amd64
  privileged: true
  tty: true
  shm_size: "2gb"
  security_opt:
    - seccomp=unconfined

services:
  spine:
    <<: *sonic-common
    container_name: sonic-spine
    hostname: spine
    networks:
      spine-leaf1-link1:
      spine-leaf1-link2:
      spine-leaf2-link1:
      spine-leaf2-link2:

  leaf1:
    <<: *sonic-common
    container_name: sonic-leaf1
    hostname: leaf1
    networks:
      spine-leaf1-link1:
      spine-leaf1-link2:

  leaf2:
    <<: *sonic-common
    container_name: sonic-leaf2
    hostname: leaf2
    networks:
      spine-leaf2-link1:
      spine-leaf2-link2:

  topology-init:
    image: docker:26
    container_name: sonic-topology-init
    depends_on:
      - spine
      - leaf1
      - leaf2
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "echo 'Waiting for SONiC spine to be ready...';
      until docker exec sonic-spine sh -c 'sonic-cfggen -h >/dev/null 2>&1'; do
        echo '  spine not ready yet...';
        sleep 5;
      done;
      echo 'Running containers:';
      docker ps --filter 'name=sonic-';
      echo 'Sleep 30...';
      sleep 30;
      echo 'Configuring spine ports...';
      docker exec sonic-spine sh -c 'config interface startup Ethernet0';
      docker exec sonic-spine sh -c 'config interface startup Ethernet4';
      docker exec sonic-spine sh -c 'config interface startup Ethernet8';
      docker exec sonic-spine sh -c 'config interface startup Ethernet12';
      echo 'Configuring leaf1 ports...';
      docker exec sonic-leaf1 sh -c 'config interface startup Ethernet0';
      docker exec sonic-leaf1 sh -c 'config interface startup Ethernet4';
      echo 'Configuring leaf2 ports...';
      docker exec sonic-leaf2 sh -c 'config interface startup Ethernet0';
      docker exec sonic-leaf2 sh -c 'config interface startup Ethernet4';
      echo 'Topology configured.'"